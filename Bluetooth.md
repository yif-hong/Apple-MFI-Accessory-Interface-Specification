# Apple: MFI开发接口规范 R29

## 61. Bluetooth

集成蓝牙技术的附件必须符合本章中的要求。

与设备兼容的每个附件都必须支持蓝牙核心规范版本2.1 + EDR或更高版本。 该规范引入了重要的安全功能Secure Simple Pairing以及Extended Inquiry Response。

### 增强的数据速率

蓝牙2.0规范中引入的增强型数据速率（EDR）功能使附件能够更有效地进行通信。 每个配件必须使用EDR，原因如下：
- 与基本数据速率（BDR）相比，它提供更高的数据速率。
- 它可以更有效地进行通信，每单位时间传输更多数据位。
- 它降低了每位传输的功耗。
- 它改善了与Wi-Fi和其他连接蓝牙设备的共存，因为它可以节省更多的播出时间。
- 它提高了多点配置的性能

### 自适应跳频

### 低功耗嗅探模式

与iOS设备和Mac计算机兼容的附件也必须尽可能使用嗅探模式，尤其是当通过蓝牙链接传输的数据很少或没有时。 除了功耗优势外，嗅探模式还可以通过Wi-Fi实现更好的天线共享。

嗅探模式参数特定于使用模型和蓝牙配置文件。 设备期望附件针对特定用途请求具有适当参数的嗅探模式。 如果附件没有发送这样的请求，则设备可以发送嗅探模式请求。 当设备发送嗅探模式请求时，远程设备必须接受请求及其参数而不进行协商。

如果附件设置了嗅探模式参数，则附件必须将嗅探间隔设置为小于蓝牙基带链路监控超时的三分之一，请参阅链路监控超时（第500页）。 这使得蓝牙链路不易受到干扰。 为了提高链路稳健性，附件必须使用较短的嗅探间隔而不是多次嗅探尝试。

具有1秒或更长的嗅探间隔的链接使得从设备打开大的相关窗口，在计算嗅探尝试的次数时必须将其考虑在内。 如果嗅探间隔小于1秒，多次嗅探尝试可以提高链路稳健性，但会增加功耗。

###	任务和优先级管理

- 设备接受任务切换请求。
- 当设备拒绝任务切换请求时，继续连接。

在蓝牙连接中，一个设备是主设备，另一个设备是从设备。 主设备可以有多个从设备，从而形成微微网。 主设备也可以是另一个主设备的从设备，创建一个散射网。

附件应避免请求成为主设备，因为设备需要在更频繁出现的情况下成为主设备。 始终坚持做主设备的配件可能会影响整体用户体验。

同时连接到多个iOS设备或Mac计算机的附件必须支持创建散射网。

### 扩展的查询响应

每个与设备兼容的附件都必须提供扩展查询响应数据包中的以下信息：

- 附件的本地名称（完整或简称）。
- TX功率电平。
- 适用的iAP2协议的服务类UUID（请参阅iAP2（第509页））。

在蓝牙发现过程中，设备更喜欢显示已发现附件的友好名称。 在2.1版本的蓝牙规范之前，设备必须建立与附件的连接并执行远程名称请求，该请求需要功率，天线时间和用户时间。 蓝牙2.1中引入的扩展查询响应功能允许附件发送其本地名称和其他信息以及查询响应，从而增加了速度和发现过程的效率。

本地名称必须与附件的标记和包装相匹配，不得包含“：”或“;”。

### 安全简单配对

- 使用安全简单配对。
- 如果数字比较方法有支持它的显示和输入设备，请使用它。

安全简单配对极大地提高了安全性，是蓝牙2.1规范中引入的强制性安全功能。 为了防止中间人攻击，必须在可行的情况下使用数值比较关联模型。 请参阅蓝牙核心规范2.1版+ EDR中的第1卷第5.4节。

### 蓝牙图标

### 设备类别

iOS设备和Mac计算机使用附件的设备类别用于UI或配置特定功能。
与设备兼容的每个附件都必须使用Bluetooth SIG定义的主要设备类和次要设备类准确设置其设备类别。 请参阅蓝牙核心规范5.0版中的第3卷，C部分，第3.2.4节。
例如，用于在车辆中操作的音频/视频附件应将主要设备类别设置为音频/视频，将次要设备类别设置为汽车音频。

### 链路监控超时

链路监控超时附件必须将链路监控超时设置为2秒或更长时间，以便考虑到RF信号的不可预测性以及设备为其他并发无线系统提供服务的需要。

### 延迟报告

设备（从iOS 8.2开始）支持蓝牙音频/视频分发传输协议1.3版中指定的延迟报告命令。 附件必须提供此信息，因为它用于改善视频播放的音频/视频同步。 附件不应报告超过1000毫秒的延迟，并且不应每秒更新延迟超过1次

### 配置文件

#### 设备ID配置文件 DID

- 支持1.3版或更高版本的蓝牙设备ID配置文件。
- 使用Bluetooth SIG指定的Assigned Numbers规范中的公司标识符作为其供应商ID值（VID）。请参阅http://www.bluetooth.org/Technical/AssignedNumbers/identifiers.htm（要求登录）。如果制造商没有Bluetooth SIG公司标识符，则蓝牙HID配置文件附件可以使用由USB实施者论坛（USB-IF在http://www.usb.org）分配的VID。
- 将其VID值用于最终产品制造商。
- 不使用Bluetooth SIG分配给Apple的公司ID或USB实施者论坛分配给Apple的供应商ID。
- 使用“供应商ID源”字段标识分配了“供应商ID”字段值中使用的值的组织。请参阅蓝牙设备ID配置文件规范的第5.6节。
- 使用唯一标识产品的ProductID值。
- 使用唯一标识软件版本的版本值。如果附件支持iAP2，则此值必须与IdentificationInformation（第906页）消息中使用的固件版本匹配。

设备ID记录允许设备识别远程附件的实现。 这是有价值的信息，可用于在与远程附件通信时桥接蓝牙规范的替代解释。 因此，设备ID记录中的信息唯一地标识实现是很重要的。

例如，对于蓝牙车载套件设备，相同的车载套件可能会分为两种不同的车型。
理想情况下，两个车载套件应具有不同的ProductID。 但是，只要具有相同的硬件，软件和功能，就可以使用相同的ProductID。 如果实现完全不同，则它们必须具有不同的ProductID。 附件还可以使用辅助设备ID记录来唯一标识产品ID或型号。

#### 服务发现协议（SDP）

- 支持ServiceDiscoveryServer服务类。
- 支持ServiceDatabaseState属性：
	只要添加，删除或修改记录中的任何SDP服务记录或属性，属性的值就必须更改。
	由于设备在连接时单独查询这些值，因此该属性的值不得基于RFCOMM通道协议参数进行更改。

#### 免提配置文件（HFP）

##### 远程音频音量控制

- 支持远程音频音量控制，因此可以通过设备控制免提配件上的扬声器音量，如蓝牙免提模式规范1.5版中的第4.28节所述。
- 在使用AT + BRSF =命令发送的支持的功能位图中设置远程音量控制位。

##### 指标事件报告

与设备兼容并支持HFP的每个附件都必须使用指示器事件报告，而不是执行重复的状态轮询。

##### 语音识别激活

- 支持语音识别激活，AG和HF均按照蓝牙免提模式规范1.5版中的第4.25节所述启动。
- 在使用AT + BRSF =command发送的“SupportedFeatures”位图中设置语音识别激活位。

iOS设备和Mac计算机支持由远程（免提）配件和iOS（音频网关）配件启动的语音识别。

##### 回声消除和降噪

当在免提附件上本地执行回声消除和降噪时，它必须通过发送AT + NREC命令关闭设备上的回声消除和降噪，如蓝牙免提配置文件规范版本中的第4.24节所述1.5。
iOS设备和Mac计算机支持回声消除和降噪，这些功能默认开启。如果免提附件也可以进行回声消除和降噪，则需要在设备（音频网关）上关闭其功能。 这避免了由于双音频处理而导致的音频质量的不必要降级。

##### 内置响铃

车机若支持HFP，则按照蓝牙免提配置文件规范版本中的第4.13.1节所述1.5，必须支持内置响铃。如果用户在设备上设置了响铃，则免提车机必须也要同样相应。

##### 同步连接

支持HFP必须：
- 支持eSCO参数集S2和S3，并接受这些设置的请求。 请参阅蓝牙免提配置规范1.5版的5.6节。
- 设置同步连接时请求eSCO参数集S2或S3。请注意，不得请求eSCO参数集S1。
- 设置SCO / eSCO连接后40 ms内呈现音频。

eSCO数据包类型提供数据包的重传; 不重传传统的SCO数据包。 这可以改善音频质量和用户体验。 eSCO数据包类型2-EV3和3-EV3在数据包之间提供了更长的时间间隔，这可以提高Wi-Fi性能并允许其他并发蓝牙连接发送数据的时间。苹果强烈建议使用2-EV3和3 用于SCO连接的EV3数据包。
强烈建议不要使用HV3数据包。 HV3分组需要更多的链路时间，并且不允许重传音频分组，这会在存在RF干扰的情况下影响音频性能。

##### 网络语音

与设备兼容并支持HFP的每个附件都必须支持宽带语音，如蓝牙免提模式规范1.6版的第5.7.4节所述。 如果支持宽带语音，则必须支持T2链接参数设置。
所有运行iOS 5或更高版本的设备都支持宽带语音。 如果设备和附件都支持宽带语音，那么宽带语音链接将用于eSCO连接，用于蜂窝电话，FaceTime和Siri.eech等用例

#### 消息访问配置文件（MAP） 

- 支持消息通知，如蓝牙消息访问配置文件规范1.0版第4.1节中所述。
- 建立连接后立即注册通知，如消息访问配置文件规范1.0版中的第4.5节所述。
- 不要指望TEL属性存在于发起者VCARD中（将包括属性N和FN）。请参阅消息访问配置文件规范1.0版中的第3.1.3节。
- 不提供用于发送消息的用户界面。 设备不支持使用MAP发送消息。

ios6.0及以后都支持MAP。

#### 音频/视频远程控制配置文件（AVRCP）

##### 支持的功能

- 播放
- 停止
- 暂停
- 快进
- 快退
- 向前
- 向后

##### 重复和随机模式

##### 通知

与设备兼容并支持AVRCP的每个附件都必须注册通知，而不是执行重复轮询以确定设备的状态。

- EVENT_PLAYBACK_STATUS_CHANGED
- EVENT_TRACK_CHANGED
- EVENT_NOW_PLAYING_CONTENT_CHANGED
- EVENT_AVAILABLE_PLAYERS_CHANGED
- EVENT_ADDRESSED_PLAYER_CHANGED
- EVENT_VOLUME_CHANGED

##### 播放暂停按钮

参照504页

- 如果设备已通知附件已暂停，则按附件的播放/暂停按钮必须发送播放命令。
- 如果设备已通知附件正在播放，则按附件的播放/暂停按钮必须发送暂停命令。
- 附件不得根据按下播放/暂停按钮的次数推断设备播放状态。

##### 音量处理

##### 浏览

- 连接时不要尝试索引或缓存整个库。 该设备可能包含数万个媒体项目，每个媒体项目在层次结构中多次出现。
- 浏览特定文件夹时，请勿获取其所有项目。 仅获取向用户显示的内容。 它可以预取一些项目以提高用户界面的响应能力。
- 不重新排序项目（例如按字母顺序排列）。
- 不要假设UID是静态定义的，尤其是在根文件夹中。 文件夹和项目的排序和UID可能会在将来的版本中随时更改。
- 收到EVENT_UIDS_CHANGED通知后发送SetBrowsedPlayer命令。
- 不要假设传递给PlayItem命令的UID将导致媒体播放器播放该UID。

目前只有内置的音乐应用支持浏览。 在玩家之间切换时，将生成EVENT_AVAILABLE_PLAYERS_CHANGED通知和EVENT_ADDRESSED_PLAYER_CHANGED通知。 然后，UI需要查看列出的播放器的功能位掩码，以确定当前是否可以进行浏览。

所有运行iOS 6.0或更高版本的设备都支持AVRCP浏览。

##### iOS App提供的元数据

在设备上运行的音频应用可以使用iOS Media Player Framework来提供有关当前音频流的元数据。 设备使用AVRCP将此元数据提供给附件。 有关更多信息，请参阅Apple Media Player Framework文档中的MPNowPlayingInfoCenter类。

#### 高级音频分发配置文件（A2DP）

参照478页。

### 音频通道

本节介绍附件如何区分来自设备的各种音频内容，并使用此信息来决定播放行为。

附件可以通过两个蓝牙配置文件从设备接收音频数据：

- HFP使用eSCO通道
- A2DP使用ACL通道

设备根据音频内容的使用方式选择要使用的频道。 为双向通信（例如电话呼叫或FaceTime）创建的音频路径始终使用HFP（eSCO）通道来发送音频数据。 音乐和类似内容使用A2DP通道。 如果没有定义的通道，音频播放将默认为设备。

如果附件已使用Lightning接口连接到设备，则使用蓝牙连接不得暂停任何播放音频。

#### 通过HFP配置文件接受音频数据

通过HFP（eSCO）发送的大多数音频内容需要双向通信。 使用HFP（eSCO）的情况包括（但不限于）蜂窝呼叫，FaceTime和语音邮件。

对于通过HFP（eSCO）路由接收的任何音频内容，一般来说附件的扬声器和麦克风都专用于蓝牙链路，并且不得处理任何其他音频内容。

#### 通过A2DP配置文件接受音频数据

通过A2DP配置文件传输的音频内容大致可分为两类：
- 来自音乐，视频或类似游戏的应用程序的音频内容。
- 系统生成的警报和通知声音。

##### 区分音频内容与系统声音

类似音乐的内容可以通过添加支持音频/视频远程控制配置文件（AVRCP）版本1.3或更高版本来区分。 AVRCP配置文件允许配件使用通知了解设备中的音频播放状态。 请参阅音频/视频远程控制配置文件（AVRCP）（第504页）。

当设备通过A2DP通道启动音频播放以播放音乐内容时，将发送AVRCP通知EVENT_PLAYBACK_STATUS_CHANGED以指示播放状态已更改为播放状态。 请参见音频/视频远程控制配置文件规范1.4版的第6.7.2节。 这表示通过A2DP配置文件的音频数据包含音乐。 当设备通过A2DP通道启动音频播放以播放系统声音时，不会发送AVRCP通知。

##### A2DP音频通道的需求

如果音频数据包含音乐，那么通过蓝牙链接可以看到通过蓝牙链接进行音频播放，并且暂停任何其他音频播放。 如果音频数据包含系统声音，则期望附件可以根据需要呈现音频。 如果附件正在播放来自不同源的音频，则系统声音数据可以与现有轨道混合以进行回放; 没有必要暂停设备上现有的音频播放。

### HID

- 必须支持蓝牙HID 1.1。
- 必须支持嗅探模式（请参阅嗅探模式以获得低功耗（第497页））。
- 应该在SDP中使用以下参数进行嗅探：
	- HIDSSRHostMaxLatency - 450毫秒（720个插槽）
	- HIDSSRHostMinTimeout - 45毫秒（72个插槽）
- 应该使用22字节或更少的典型报告包。 这个小到足以装入带有L2CAP和HID标头的DH1数据包

### iAP2

通过蓝牙传输实现iAP2的附件还必须满足以下要求：

- 必须支持蓝牙服务发现协议（SDP）。
- SDP数据最大传输单元（MTU）必须至少为672字节。
- SDP记录不得分段。
- 必须支持扩展查询响应（EIR）。
- 必须在SDP和EIR中声明服务类UUID 0xFFCACADEAFDECADEDEFACADE00000000。
- EIR本地名称必须与标识信息（第906页）消息中的Name参数相同。

不要求特定的设备类别（CoD）或主要服务，请参阅设备类别（CoD）（第500页）。

Apple建议通过以下方式成功建立蓝牙连接：

- 如果正在使用蓝牙2.1，则实施蓝牙嗅探模式或嗅探贬值。
- 让设备成为主设备。
- 对于大数据包传输，在iAP2层保持最大传输单元（MTU）大小为1000字节和最小658字节。

与有线传输不同，无论有多少活动蓝牙连接，设备都将进入休眠状态。 从附件到设备的蓝牙流量将导致设备退出休眠状态。 因此，附件必须仅在响应直接用户操作时才为设备生成蓝牙流量。 为了使设备远离休眠而自动生成蓝牙流量会导致未能通过自我认证。

要重新建立与设备的蓝牙连接，附件必须进行蓝牙SDP查询，以查找与服务类UUID为0xFECACADEAFDECADEDEFACADE00000000相关联的RFCOMM通道，然后连接到该通道。 附件不得假设通道在连接之间保持相同。

设备也许会在以下几个情况拒绝蓝牙连接：

- 设备的蓝牙连接太多。 在这种情况下，附件将收到指示资源不可用的错误。
- 与设备的RFCOMM协议连接太多。 在这种情况下，附件将收到资源拒绝错误。

附件不能指望设备会尝试重新建立断开的蓝牙连接。

### 测试程序

#### 配对和连接建立

##### 设备到附件

1. 从设备搜索附件并启动配对。
2. 交换密码后，配对应该成功。

##### 附件到设备

1. 从附件搜索设备并启动配对（设备需要在蓝牙菜单中）。
2. 交换密码后，配对应该成功。

##### 嗅探模式

1. 让连接空闲30秒。
2. 设备应根据要求进入嗅探模式。

#### 重连

##### 从设备重连

1. 切换飞行模式并从设备重新连接蓝牙。
2. 重新连接应该是成功的。

##### 从附件重新连接

1. 切换飞行模式并从附件重新连接蓝牙（如果支持）。
2. 重新连接应该是成功的。

##### 在激活呼叫期间重新连接

1. 如果支持HFP，请在通话期间重新启动配件。
2. 重新连接应该是成功的。音频应该在上行链路和下行链路中可用。

##### 范围

1. 在通话期间将设备超出范围。 2分钟后返回蓝牙范围，并从设备/配件启动蓝牙连接。
2. 断开连接后，音频应路由到设备。重新连接后，音频应在上行链路和下行链路中可用。

#### 指标

1. 蓝牙连接后检查人机界面（HMI）。
2. 附件支持指示器（如果有）应显示正确的值：电池，信号强度，漫游指示器和运营商名称。

##### 电话

这些程序适用于支持HFP的附件。

##### 拨出电话

###### 从附件拨打

1. 在附件的HMI上输入电话号码。
2. 在远程方应答呼叫之前，应通过SCO / eSCO链接听到拨号音。一旦应答呼叫，音频应在上行链路和下行链路中可用。

###### 取消附件中的呼叫

1. 在附件的HMI上输入电话号码。等待拨号开始并按结束通话。
2. 应通过SCO / eSCO链接听到拨号音。

###### 从设备拨打

1. 在设备上输入电话号码。
2. 在远程方应答呼叫之前，应通过SCO / eSCO链路听到拨号音。一旦呼叫被应答，音频应在上行链路和下行链路中可用。

###### 从已下载的呼叫历史记录中拨打

1. 在附件上，拨打下载的呼叫历史记录中的条目。
2. 在远程方应答呼叫之前，应通过SCO / eSCO链路听到拨号音。一旦呼叫被应答，音频应在上行链路和下行链路中可用。

###### 音频传输

1. 从附件/设备，在设备和附件之间传输音频。
2. 每次操作后，音频都应被切换到正确的信号源。

###### 音频质量

1. 保持呼叫10分钟并检查音频质量。
2. 上行链路和下行链路的音频质量应该是合适的。

##### 来电

###### 带内铃声

1. 拨打来电并检查带内铃声的音频质量。
2. 铃声应该完整，听起来应该清晰。

###### 来电显示

1. 拨打来电并检查配件HMI上的来电显示。
2. 来电显示应以良好的格式显示。

###### 呼叫拒绝

1. 拨打来电并拒绝附件/设备。
2. 应拒绝接听电话。

###### 从附件接听电话

1. 拨打来电并从附件接听。
2. 一旦呼叫被应答，音频应在上行链路和下行链路中可用。

###### 应答设备呼叫

1. 拨打来电并从设备接听电话。
2. 音频应保留在设备上（隐私模式）。

###### 音频传输

1. 从附件/设备，在设备和附件之间传输音频。
2. 每次操作后，音频都应路由到正确的信号源。

###### 音频质量

1. 保持呼叫10分钟并检查音频质量。
2. 上行链路和下行链路的音频质量应该是合适的。

##### FaceTime音频

###### 传入FaceTime音频呼叫

1. 使用与来电相同的步骤（第512页）。

###### 传出FaceTime音频呼叫

1. 使用与拨出呼叫相同的步骤（第511页）。

##### 三方通话

###### 单呼叫保持/恢复

1. 在通话过程中，按HMI上的保持/继续。
2. 每次行动后都应保持/恢复通话。


###### 忽略第二次来电

1. 在通话期间，按HMI上的拒绝键忽略第二个来电。
2. 应拒绝第二次电话会议。第一次通话应保持不变。

###### 替换呼叫

1. 在通话过程中，按“替换”结束当前通话并接听第二通电话。
2. 应回答第二次电话会议。应该结束第一次通话。

###### 接听二次呼叫

1. 在通话过程中，按应答第二个来电。
2. 应回答第二次电话会议。第一次通话应该暂停。

###### 呼叫交换

1. 在HMI之间切换活动和保持的呼叫。
2. 呼叫状态应根据每个动作而改变。

###### 会议

1. 从HMI加入2个呼叫。确保保持/恢复/结束功能适用于电话会议。
2. 每一方都应该能够听到其他两方的音频。保持/恢复/结束功能应该适用
电话会议。

##### 增强的呼叫控制

###### 在三方通话中指定呼叫结束

1. 组建电话会议并指定结束其中一个电话会议。
2. 指定的呼叫应该结束。

###### 在三方通话中指定呼叫保持

1. 组建电话会议并指定暂停通话（分开会议）。
2. 指定的呼叫应保持激活状态。

##### 可视语音邮件

######  VVM播放

1. 启动VVM播放。
2. HMI应显示虚拟呼叫。音频应该清楚。

###### A2DP期间的VVM播放

1. 在A2DP流式传输期间启动VVM播放。
2. 虚拟呼叫应该开始并且应该保持不受干扰。音频应该清楚。

###### VVM回放期间回调

1. 播放VVM并按设备上的回叫。
2. 从VVM到拨出呼叫的转换应该是顺利的。

###### VVM播放期间的来电

1. 播放VVM并拨打来电。
2. 从VVM到来电的转换应该是顺利的。

#### Siri

这些程序适用于支持HFP的附件。

1. 从设备或附件触发Siri。
2. 哔哔声应完整且清晰。
3. 向Siri提出一个问题（时间，天气等）。
4. 音频应完整且清晰。在Siri提供答案后，虚拟呼叫应该很快就会结束。
5. 让Siri给某人打电话。
6. 从Siri过渡到拨出电话应该是顺利的。
7. 让Siri演奏某些曲目。
8.  Siri应该找到合适的赛道。
9. 向Siri询问方向（星巴克，全食品等）。
10. Siri应找到方向并开始逐向导航。

#### AVRCP

这些程序适用于具有所述按钮功能的附件。

##### AVRCP媒体控制

1. 播放/暂停，下一个/上一个，FF / RW。
2. 在HMI上选择时，所有控件都可以工作。

##### 绝对音量

1. 音量增大/减小。
2. 设备和配件上的音量应同步。

##### AVRCP设置控制

1. 随机、重复。
2. 在HMI上选择时，所有控件都可以工作。

##### 元数据

1. 在我的音乐，Apple音乐电台和第三方应用之间切换。
2. 每次转换后，元数据应始终有效。

##### AVRCP浏览

1. 从HMI浏览文件夹结构和介质。选择曲目和Apple Music Radio电台进行播放。
2. 设备的媒体文件夹结构应该可以在HMI上浏览。

##### AVRCP版本

1. 将配件与支持更高AVRCP版本（1.5,1.6等）的电话连接。
2. 应保留AVRCP功能（控制，元数据，浏览等）。

#### 逐向导航

这些程序适用于音频配件。

##### A2DP流式传输过程中的逐向导航

1. 流A2DP。开始逐向导航。
2. 在A2DP流式传输期间，应该听到转弯提示。提示应该是完整和健全的
明确。

##### A2DP暂停时的逐向导航

1. A2DP流。暂停音乐。开始逐向导航。
2. 在暂停状态下音乐应该能够听到转弯提示。提示应该完整且清晰。


##### HFP上的逐向导航

1. 通过HFP启用地图提示。在收听FM时，启动转弯导航。
2. 每个逐向提示都应显示虚拟呼叫。提示应该完整且清晰。

#### 电话簿

这些步骤适用于支持PBAP（电话簿访问配置文件）的附件。

##### 联系人

1. 从附件下载电话簿。
2. 下载的电话簿的大小和内容应与设备电话簿相匹配。

##### 通话记录

1. 从附件下载通话记录。
2. 下载的呼叫历史的大小和内容应与设备呼叫历史（ich，och，mch）匹配。

##### 更新

1. 从设备添加/删除联系人/呼叫历史记录。从附件再次下载。
2. 更新应在HMI上下载的电话簿/通话记录中看到。

####  iAP

本节介绍如何使用ATS设置和捕获iAP-over-Bluetooth，并详细介绍通过蓝牙传输专用于iAP的一些相关测试过程。本节不包括任何其他蓝牙配置文件测试。

##### 设备

要运行iAP-over-Bluetooth自我认证测试，您需要具备以下条件：

- 使用ATS 4.1或更高版本的Mac
- 使用ATS Utility 1.1.1或更高版本的设备
- Frontline ComProbe BPA 100分析仪或ComProbe BPA 600分析仪
- 射频屏蔽布（可选）

##### 设置测试环境

与任何无线通信技术一样，必须注意定位硬件以获得最佳数据捕获。如果RF干扰太多或者设备和附件相对于分析仪放置不正确，您可能会看到ATS跟踪中缺少蓝牙数据。 为了帮助缓解这些问题：（减少干扰的正确摆放位置方法...略p518~519）

##### 设置ATS以捕获iAP-over-Bluetooth

首次使用ATS设置iAP-over-Bluetooth捕获时，系统将提示您安装驱动程序以支持分析仪。 此外，系统可能会提示您更新分析仪上的固件。

1. 在Capture Configuration Assistant中选择分析器后，您将升级为安装分析器驱动程序。 选择安装。
2. 运行安装程序以完成。 驱动程序安装完成后，您必须重新启动Mac。
3. 重启后，启动ATS并选择分析仪。 如果连接的分析仪包含较旧的固件，系统将提示您更新它。 如果已升级，请选择“更新”。
4. 选择“安装”以安装分析仪固件更新程序的驱动程序。
5. 固件更新程序应用程序将在单独的窗口中启动。 按照屏幕上的说明更新分析仪的固件。
6. 完成后，选择“完成”，固件更新程序应用程序将关闭。
7. 您现在可以开始使用ATS捕获iAP-over-Bluetooth。


##### 使用ATS捕获iAP-over-Bluetooth

按照以下说明使用Capture Configuration Assistant设置iAP-over-Bluetooth捕获。您也可以从Advanced Capture Configuration Assistant设置蓝牙捕获。

1. 选择要使用的分析仪捕获硬件。
2. 选择“新建蓝牙捕获配置”。
3. 确保设备的蓝牙已打开且设备可被发现。选择“开始查询”以允许分析仪查找所有可发现的蓝牙设备。从设备列表中选择您的设备。
4. 确保配件的蓝牙已打开且设备可被发现。选择“开始查询”以允许分析仪查找所有可发现的蓝牙设备。从设备列表中选择您的配件。
5. 按照屏幕上的说明进行操作。请注意，只有使用iAP的附件才会在ATS Utility应用程序中显示链接密钥。
6. 选择要捕获的iAP版本。
7. 查看配置详细信息，然后按照屏幕上的说明进行操作。
8. 选择“开始捕获”后，将设备的蓝牙切换为“开”，然后点击附件的名称进行连接。您将在捕获窗口中看到iAP流量。继续使用设备和附件生成iAP流量。

##### 自主应用程序启动

在用户启动iOS应用程序启动后，验证附件是否仅发送RequestAppLaunch（第914页）。 在直接用户操作后，必须出现一个询问用户“允许”使用应用程序的对话框。

1. 确认仅响应直接用户操作从附件发送RequestAppLaunch（第914页），请参阅应用程序启动（第201页）。 请注意，此要求不适用于汽车主机。

##### 电源参数测试用例

对于不使用设备电源供电或不为设备供电的蓝牙配件，请通过IdentificationInformation消息验证配件是否声称不支持电源：

- 验证PowerProvidingCapability（第907页）是否设置为None。
- 验证MaximumCurrentDrawnFromDevice参数是否设置为0。